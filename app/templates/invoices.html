<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý hóa đơn</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .items-container {
            margin-top: 10px;
        }
        .item-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .item-row input {
            margin-right: 10px;
        }
        .item-row button {
            margin-left: 10px;
        }
        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
        }
        .suggestion-item {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quản lý hóa đơn</h1>
        <a href="/">Quay lại bảng điều khiển</a>
        <form id="invoice-form" method="POST" action="/api/invoices">
            <div class="form-group">
                <label for="date">Ngày:</label>
                <input type="date" id="date" name="date" required>
            </div>
            <div class="form-group">
                <label for="type">Loại hóa đơn:</label>
                <select id="type" name="type" required onchange="togglePurposeField()">
                    <option value="Nhập">Nhập</option>
                    <option value="Xuất">Xuất</option>
                </select>
            </div>
            <div class="form-group" id="purpose-group">
                <label for="purpose">Mục đích:</label>
                <select id="purpose" name="purpose">
                    <option value="Xuất dùng">Xuất dùng</option>
                    <option value="Bán">Bán</option>
                </select>
            </div>
            <div class="form-group">
                <label>Sản phẩm:</label>
                <div id="items-container" class="items-container"></div>
                <button type="button" onclick="addItem()">Thêm sản phẩm</button>
            </div>
            <div class="form-group">
                <label for="total">Tổng tiền:</label>
                <input type="text" id="total-display" readonly>
                <input type="hidden" id="total" name="total">
            </div>
            <div class="form-group">
                <label for="discount">Giảm giá:</label>
                <input type="text" id="discount-display" oninput="formatDiscount(this, 'discount')" value="0">
                <input type="hidden" id="discount" name="discount" value="0">
            </div>
            <div class="form-group">
                <label for="note">Ghi chú:</label>
                <textarea id="note" name="note"></textarea>
            </div>
            <input type="hidden" id="items" name="items">
            <button type="submit">Lưu</button>
        </form>
        <div class="search-bar">
            <input type="text" id="search" placeholder="Tìm kiếm theo mục đích">
            <button onclick="searchInvoices()">Tìm</button>
        </div>
        <table id="invoice-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ngày</th>
                    <th>Loại</th>
                    <th>Mục đích</th>
                    <th>Tổng tiền</th>
                    <th>Giảm giá</th>
                    <th>Sản phẩm</th>
                    <th>Ghi chú</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="pagination">
            <button onclick="prevInvoicePage()">Trước</button>
            <span id="invoice-page-info"></span>
            <button onclick="nextInvoicePage()">Sau</button>
        </div>
    </div>
    <script>
        let items = [];

        function formatCurrency(number) {
            if (typeof number !== 'number' || isNaN(number)) {
                return '0';
            }
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatDiscount(input, hiddenFieldId) {
            let value = input.value.replace(/\D/g, '');
            if (!value) {
                input.value = '0';
                document.getElementById(hiddenFieldId).value = '0';
                return;
            }

            let number = parseInt(value);
            let formatted = formatCurrency(number);
            input.value = formatted;
            document.getElementById(hiddenFieldId).value = number;
        }

        function addItem() {
            const container = document.getElementById('items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.innerHTML = `
                <input type="text" class="product-input" placeholder="Tìm sản phẩm..." oninput="suggestProducts(this)">
                <div class="suggestions" style="display: none;"></div>
                <input type="number" class="quantity-input" placeholder="Số lượng" oninput="updateTotal()">
                <button type="button" onclick="removeItem(this)">Xóa</button>
            `;
            container.appendChild(itemDiv);
        }

        function removeItem(button) {
            button.parentElement.remove();
            updateTotal();
        }

        async function suggestProducts(input) {
            const query = input.value;
            const suggestionsDiv = input.nextElementSibling;
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const response = await fetch(`/api/products/suggest?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            suggestionsDiv.innerHTML = '';
            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsDiv.style.display = 'block';
                data.suggestions.forEach(product => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = `${product.code} - ${product.name}`;
                    suggestionItem.onclick = () => {
                        input.value = product.name; // Giữ lại tên sản phẩm
                        input.dataset.productId = product.id;
                        input.dataset.productName = product.name; // Lưu tên vào dataset
                        input.dataset.sellingPrice = product.selling_price;
                        suggestionsDiv.style.display = 'none';
                        updateTotal();
                    };
                    suggestionsDiv.appendChild(suggestionItem);
                });
            } else {
                suggestionsDiv.style.display = 'none';
            }
        }

        function updateTotal() {
            items = [];
            let total = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const productInput = row.querySelector('.product-input');
                const quantityInput = row.querySelector('.quantity-input');
                if (productInput.dataset.productId && quantityInput.value) {
                    const quantity = parseInt(quantityInput.value);
                    const sellingPrice = parseFloat(productInput.dataset.sellingPrice) || 0;
                    items.push({ 
                        id: parseInt(productInput.dataset.productId), 
                        quantity,
                        name: productInput.dataset.productName // Lưu tên sản phẩm vào items
                    });
                    total += quantity * sellingPrice;
                    // Đảm bảo ô nhập liệu hiển thị tên sản phẩm
                    if (productInput.dataset.productName) {
                        productInput.value = productInput.dataset.productName;
                    }
                }
            });
            document.getElementById('total').value = total;
            document.getElementById('total-display').value = formatCurrency(total);
            document.getElementById('items').value = JSON.stringify(items);
        }

        function togglePurposeField() {
            const typeSelect = document.getElementById('type');
            const purposeGroup = document.getElementById('purpose-group');
            if (typeSelect.value === 'Nhập') {
                purposeGroup.style.display = 'none';
            } else {
                purposeGroup.style.display = 'block';
            }
        }

        // Tự động điền ngày hiện tại
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;

            // Ẩn trường Mục đích nếu loại hóa đơn là Nhập
            togglePurposeField();
        });

        document.getElementById('invoice-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            // Kiểm tra ít nhất một sản phẩm
            if (items.length === 0) {
                alert('Vui lòng chọn ít nhất một sản phẩm.');
                return;
            }

            const formData = new FormData(event.target);
            const type = formData.get('type');
            if (type === 'Nhập') {
                formData.set('purpose', 'Nhập kho');
            }
            try {
                const response = await fetch('/api/invoices', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    event.target.reset();
                    document.getElementById('items-container').innerHTML = '';
                    document.getElementById('total-display').value = '';
                    document.getElementById('discount-display').value = '0';
                    document.getElementById('discount').value = '0';
                    items = [];
                    togglePurposeField();
                    searchInvoices();
                } else {
                    alert(data.message);
                }
            } catch (error) {
                console.error('Lỗi khi thêm hóa đơn:', error);
                alert('Lỗi khi thêm hóa đơn. Vui lòng thử lại.');
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>